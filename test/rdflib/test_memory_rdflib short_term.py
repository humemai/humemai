"""Test Memory class"""

import os
import unittest
from datetime import datetime
from unittest.mock import MagicMock

from rdflib import RDF, XSD, BNode, Graph, Literal, Namespace, URIRef

from humemai.rdflib import Humemai

# Define custom namespace for humemai ontology
humemai = Namespace("https://humem.ai/ontology#")


class TestMemoryShortTerm(unittest.TestCase):

    def setUp(self) -> None:
        """
        Set up a fresh Memory instance before each test.
        """
        self.memory = Humemai()
        self.humemai = Namespace("https://humem.ai/ontology#")

    def test_add_single_short_term_memory(self) -> None:
        """
        Test adding a single short-term memory with current location and current time.
        """
        # Define the sample triple
        triple = (
            URIRef("https://example.org/person/Alice"),
            URIRef("https://example.org/relationship/knows"),
            URIRef("https://example.org/person/Bob"),
        )
        current_time = Literal("2024-04-27T10:00:00", datatype=XSD.dateTime)
        qualifiers = {
            self.humemai.location: Literal("New York"),
            self.humemai.current_time: current_time,
        }

        # Add the short-term memory
        self.memory.add_short_term_memory([triple], qualifiers)

        # Verify that the memory was added with the correct qualifiers
        result = self.memory.print_memories(True)
        self.assertIn("Alice", result)

        # Check for 'current_time' and 'location'
        self.assertIn("current_time", result)
        self.assertIn("2024-04-27T10:00:00", result)
        self.assertIn("location", result)
        self.assertIn("New York", result)

    def test_add_short_term_memory_with_default_time(self) -> None:
        """
        Test adding a short-term memory without specifying the current time.
        The system should use the current time automatically.
        """
        # Define the sample triple
        triple = (
            URIRef("https://example.org/person/Charlie"),
            URIRef("https://example.org/relationship/likes"),
            Literal("Ice Cream"),
        )
        location = Literal("Berlin")
        qualifiers = {self.humemai.location: location}

        # Capture the current time before adding the memory
        before_time = datetime.now().isoformat(timespec="seconds")

        # Add the short-term memory without specifying time
        self.memory.add_short_term_memory([triple], qualifiers)

        # Capture the result and verify
        result = self.memory.print_memories(True)
        self.assertIn("Charlie", result)
        self.assertIn("location", result)
        self.assertIn("Berlin", result)

        # Ensure the current_time was added automatically
        self.assertIn("current_time", result)

        # Extract all dynamically assigned current_time values from the graph
        current_times_in_graph = list(
            self.memory.graph.objects(None, self.humemai.current_time)
        )

        # Verify that one of the current_time values is close to the current time
        after_time = datetime.now().isoformat(timespec="seconds")

        self.assertTrue(
            any(
                before_time <= current_time <= after_time
                for current_time in current_times_in_graph
            ),
            "The current_time should be within the expected range.",
        )

    def test_add_multiple_short_term_memories(self) -> None:
        """
        Test adding multiple triples as short-term memory.
        """
        # Define multiple triples
        triples = [
            (
                URIRef("https://example.org/person/David"),
                URIRef("https://example.org/relationship/knows"),
                URIRef("https://example.org/person/Eve"),
            ),
            (
                URIRef("https://example.org/person/Eve"),
                URIRef("https://example.org/relationship/likes"),
                Literal("Chocolate"),
            ),
        ]
        current_time = Literal("2024-04-28T09:00:00", datatype=XSD.dateTime)
        qualifiers = {
            self.humemai.location: Literal("Tokyo"),
            self.humemai.current_time: current_time,
        }

        # Add the short-term memory with multiple triples
        self.memory.add_short_term_memory(triples, qualifiers)

        # Verify both triples were added correctly
        result = self.memory.print_memories(True)
        self.assertIn("David", result)
        self.assertIn("Eve", result)
        self.assertIn("Chocolate", result)
        self.assertIn("current_time", result)
        self.assertIn("2024-04-28T09:00:00", result)
        self.assertIn("location", result)
        self.assertIn("Tokyo", result)


class TestGetShortTerm(unittest.TestCase):
    def setUp(self) -> None:
        """Set up the test case with a Memory instance and populate the RDF graph."""
        # Initialize a Memory instance and use an actual Graph instance
        self.memory = Humemai()
        self.memory.graph = Graph()

        # Short-term triple
        self.subj = URIRef("https://example.org/person/Alice")
        self.pred = URIRef("https://example.org/event/met")
        self.obj = URIRef("https://example.org/person/Bob")

        # Qualifiers for the short-term memory
        self.current_time_qualifier = URIRef("https://humem.ai/ontology#current_time")
        self.location_qualifier = URIRef("https://humem.ai/ontology#location")
        self.emotion_qualifier = URIRef("https://humem.ai/ontology#emotion")

        self.current_time_literal = Literal("2024-10-03T15:00:00", datatype=XSD.dateTime)
        self.location_literal = Literal("New York", datatype=XSD.string)
        self.emotion_literal = Literal("happy", datatype=XSD.string)

        # Create a reified statement for the triple (Alice, met, Bob)
        self.reified_statement = BNode()

        # Add the reified statement and its qualifiers to the graph
        self.memory.graph.add((self.reified_statement, RDF.type, RDF.Statement))
        self.memory.graph.add((self.reified_statement, RDF.subject, self.subj))
        self.memory.graph.add((self.reified_statement, RDF.predicate, self.pred))
        self.memory.graph.add((self.reified_statement, RDF.object, self.obj))
        self.memory.graph.add(
            (
                self.reified_statement,
                self.current_time_qualifier,
                self.current_time_literal,
            )
        )
        self.memory.graph.add(
            (self.reified_statement, self.location_qualifier, self.location_literal)
        )
        self.memory.graph.add(
            (self.reified_statement, self.emotion_qualifier, self.emotion_literal)
        )

    def testget_short_term_memories(self) -> None:
        """Test that short-term memories with current_time are correctly retrieved and added to the Memory object."""
        # Call the method to retrieve short-term memories
        short_term_memory = self.memory.get_short_term_memories()

        # Assertions to check if the triples and their qualifiers were added to the short-term memory
        # Check if the triple (Alice, met, Bob) was added
        self.assertIn((self.subj, self.pred, self.obj), short_term_memory.graph)

        # Check if the reified statement with qualifiers (current_time, location, emotion) was added
        reified_statements = list(
            short_term_memory.graph.triples((None, RDF.type, RDF.Statement))
        )
        self.assertEqual(len(reified_statements), 1)  # Only one reified statement

        reified_statement = reified_statements[0][0]

        # Check if reified statement has the correct subject, predicate, and object
        self.assertIn(
            (reified_statement, RDF.subject, self.subj), short_term_memory.graph
        )
        self.assertIn(
            (reified_statement, RDF.predicate, self.pred), short_term_memory.graph
        )
        self.assertIn(
            (reified_statement, RDF.object, self.obj), short_term_memory.graph
        )

        # Check if the correct qualifiers were added
        self.assertIn(
            (reified_statement, self.current_time_qualifier, self.current_time_literal),
            short_term_memory.graph,
        )
        self.assertIn(
            (reified_statement, self.location_qualifier, self.location_literal),
            short_term_memory.graph,
        )
        self.assertIn(
            (reified_statement, self.emotion_qualifier, self.emotion_literal),
            short_term_memory.graph,
        )

    def test_empty_short_term_memory(self) -> None:
        """Test that the method handles an empty graph correctly."""
        # Use an empty graph
        self.memory.graph = Graph()

        # Call the method to retrieve short-term memories
        short_term_memory = self.memory.get_short_term_memories()

        # Ensure the graph is empty in this case
        self.assertEqual(
            len(list(short_term_memory.graph.triples((None, None, None)))), 0
        )

    def test_partial_qualifiers_in_short_term_memory(self) -> None:
        """Test that short-term memories handle cases where some qualifiers are missing."""
        # Clear the graph and set up a partial reified statement with only some qualifiers (no emotion)
        self.memory.graph = Graph()

        # Add the reified statement with only current_time and location qualifiers
        self.memory.graph.add((self.reified_statement, RDF.type, RDF.Statement))
        self.memory.graph.add((self.reified_statement, RDF.subject, self.subj))
        self.memory.graph.add((self.reified_statement, RDF.predicate, self.pred))
        self.memory.graph.add((self.reified_statement, RDF.object, self.obj))
        self.memory.graph.add(
            (
                self.reified_statement,
                self.current_time_qualifier,
                self.current_time_literal,
            )
        )
        self.memory.graph.add(
            (self.reified_statement, self.location_qualifier, self.location_literal)
        )

        # Call the method to retrieve short-term memories
        short_term_memory = self.memory.get_short_term_memories()

        # Assertions to check if the triple and available qualifiers were added
        reified_statements = list(
            short_term_memory.graph.triples((None, RDF.type, RDF.Statement))
        )
        self.assertEqual(len(reified_statements), 1)
        reified_statement = reified_statements[0][0]

        # Ensure the triple (Alice, met, Bob) exists
        self.assertIn((self.subj, self.pred, self.obj), short_term_memory.graph)

        # Ensure the reified statement has the correct subject, predicate, object
        self.assertIn(
            (reified_statement, RDF.subject, self.subj), short_term_memory.graph
        )
        self.assertIn(
            (reified_statement, RDF.predicate, self.pred), short_term_memory.graph
        )
        self.assertIn(
            (reified_statement, RDF.object, self.obj), short_term_memory.graph
        )

        # Check the available qualifiers (no emotion)
        self.assertIn(
            (reified_statement, self.current_time_qualifier, self.current_time_literal),
            short_term_memory.graph,
        )
        self.assertIn(
            (reified_statement, self.location_qualifier, self.location_literal),
            short_term_memory.graph,
        )
        self.assertNotIn(
            (reified_statement, self.emotion_qualifier, self.emotion_literal),
            short_term_memory.graph,
        )
